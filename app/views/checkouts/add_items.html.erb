<script>
var item_count = <%= @items.present? ? @items.length : 0 %>;

function add_items_on_load() {
	// Prevent the fake row from actually being submitted
	$('#item_row').find('select, input.item_name').each(function() { $(this).attr('name', ''); });
}

function get_item_data(item_id) {
	var jsonItem = {};
	$.ajax({
	  url: '<%= items_path %>/' + item_id + '.json',
	  dataType: 'json',
	  async: false,
	  success: function(data) {
	    jsonItem = data;
	  }
	});
	
	return jsonItem;
}

function add_row(data) {
	var item_data = get_item_data(data);

	var ref = document.getElementById('item_tab');
	var $datetime = $('#item_row').clone(); // Clone the hidden row
	
	$datetime.find('input.item_name').attr('value', item_data.name);
	$datetime.find('input.item_id').attr('value', data);
	// Do some jquery magic to fix id's of datetime's selects
	$datetime.find('select').each(function() {
		var curr_id = $(this).attr('id');
		var id_parts = curr_id.split('_');
		$(this).attr('id', 'checkout_checkedout_items_attributes_' + item_count + '_startdate_' + id_parts[6]);
		$(this).attr('name', 'checkout[checkedout_items_attributes][' + item_count + '][startdate(' + id_parts[6] + ')]');
	});
	$datetime.find('input.item_name').each(function() {
		$(this).attr('id', 'checkout_checkedout_items_attributes_' + item_count + '_item_attributes_name');
		$(this).attr('name', 'checkout[checkedout_items_attributes][' + item_count + '][item_attributes][name]');
	});
	$datetime.find('input.item_id').each(function() {
		$(this).attr('id', 'checkout_checkedout_items_attributes_' + item_count + '_item_attributes_id');
		$(this).attr('name', 'checkout[checkedout_items_attributes][' + item_count + '][item_attributes][id]');
	});
	
	if(item_count == 0) {
		ref.deleteRow(0);	// Delete the "empty table" text
	}
	
	item_count++;
	ref.insertRow(ref.rows.length); 
	ref.rows[ref.rows.length-1].innerHTML = $datetime.html();
}

$(document).ready(function() {
	add_items_on_load()
});
</script>

<h1>Scan Items</h1>

<%= render 'qr' %>

<%= form_tag 'add_dates' do %>
  <%= fields_for @student, :include_id => false, builder: ComboboxFormBuilder do |s| %>
	  <div class="field" style="display:none">
	    <%= s.text_field(:firstname, :value => @student.firstname, :class => "student_info")%>
	  </div>
	  <div class="field" style="display:none">
	    <%= s.text_field(:lastname, :value => @student.lastname, :class => "student_info")%>
	  </div>
	  <div class="field" style="display:none">
	    <%= s.text_field(:uin, :value => @student.uin, :class => "student_info")%>
	  </div>
	  <div class="field" style="display:none">
	    <%= s.text_field(:email, :value => @student.email, :class => "student_info")%>
	  </div>
	  <div class="field" style="display:none">
	    <%= s.text_field(:phonenumber, :value => @student.phonenumber, :class => "student_info")%>
	  </div>
  <% end %>
  <div class="field">
  <table id="item_tab">
  	<%= text_field_tag "item_ids[]" %>
  	<%= text_field_tag "item_ids[]" %>
  </table>
  </div>
  <div class="actions">
    <%= submit_tag "Finish"%>
  </div>
  <audio id="scanned" src=<%= asset_path('chime.wav') %> style="display:none" />
<% end %>
